# 大会システム - シングルプレイヤー動作テスト手順

## 概要
一人で大会システム全体の動作を確認するためのテスト手順です。  
本番前にこの手順で動作確認を行ってください。

## 前提条件
- デプロイされたアプリケーションにアクセス可能
- 管理者権限を持つアカウントでログイン可能
- Google Sheetsへのアクセス権限あり

## 事前準備
### 1. 必要シートの確認・作成
1. **管理者ダッシュボード** → **シート管理** にアクセス
2. **TournamentMatchesシート** の作成状況を確認
3. 未作成の場合は「TournamentMatchesシートを作成」ボタンをクリック
4. 作成完了を確認

### 2. テスト用データの準備
```
ログインアカウント（管理者権限）:
- ID: admin_test
- ニックネーム: テスト管理者

テスト用プレイヤー（既存データ活用）:
- ちーけん (1650pt)
- ワラビサコ (1580pt) 
- その他ランキング上位プレイヤー
```

## テスト手順

### Phase 1: エントリー機能テスト
#### 1.1 大会エントリー状況確認
1. **管理者ダッシュボード** → **プレイヤー管理** にアクセス
2. 現在のtournament_active状況を確認
3. 必要に応じて「大会状態をリセット」で全プレイヤーを非アクティブに

#### 1.2 QRコード生成テスト
1. **管理者ダッシュボード** → **QRコード表示** にアクセス
2. エントリー用QRコードが正しく生成されることを確認
3. QRコードをスクリーンショット保存（スマホテスト用）

#### 1.3 エントリー動作テスト
1. スマホまたは別ブラウザでQRコードスキャン機能にアクセス
2. QRコードをスキャン（カメラまたは画像アップロード）
3. エントリー完了画面が表示されることを確認
4. 5秒後に待機画面に自動遷移することを確認

#### 1.4 複数プレイヤーエントリー
1. 管理者画面で他のプレイヤーを手動でアクティブ設定
   - **プレイヤー管理** → 各プレイヤーの「エントリー」ボタン
   - 最低4名程度をアクティブにする
2. **管理者ダッシュボード**でエントリー数が正しく表示されることを確認

### Phase 2: 組み合わせ決定テスト
#### 2.1 組み合わせ生成機能
1. **管理者ダッシュボード** → **組み合わせ決定** にアクセス
2. エントリー済みプレイヤー一覧が正しく表示されることを確認
3. 対戦方式選択テスト:
   - **ランダム**: ランダム組み合わせを生成
   - **レーティング考慮**: レート順組み合わせを生成
   - **手動設定**: 未実装メッセージ確認

#### 2.2 組み合わせ確定
1. 生成された組み合わせプレビューを確認
2. プレイヤー入れ替え機能（シャッフルボタン）をテスト
3. 「確定する」ボタンで組み合わせを保存
4. Google SheetsのTournamentMatchesシートにデータが保存されることを確認

### Phase 3: 対戦結果システムテスト
#### 3.1 対戦結果報告（プレイヤー側）
1. 別ブラウザ/プライベートモードで一般プレイヤーとしてアクセス
2. **対戦結果報告** にアクセス（URLは `/match-result` または管理者から案内）
3. Mock対戦データが表示されることを確認:
   - プレイヤー1 vs プレイヤー2
   - テーブル番号、レーティング情報
4. 結果報告テスト:
   - 「勝利」または「敗北」を選択
   - メモ入力（任意）
   - 確認ダイアログで「結果を報告」
5. 報告完了メッセージを確認

#### 3.2 結果承認（管理者側）
1. **管理者ダッシュボード** → **対戦結果承認** にアクセス
2. 承認待ち一覧に先ほど報告した結果が表示されることを確認
3. 結果詳細表示:
   - 👁️アイコンで詳細ダイアログを開く
   - 勝者、報告者、メモ内容を確認
4. 承認処理テスト:
   - ✅（承認）ボタンをクリック
   - ELO計算・レート更新の完了メッセージを確認
   - 承認待ち一覧から該当項目が消えることを確認

#### 3.3 却下テスト
1. 追加の対戦結果を報告
2. ❌（却下）ボタンでの却下処理をテスト
3. 却下後の状態確認

### Phase 4: データ整合性確認
#### 4.1 Google Sheetsデータ確認
1. **TournamentMatches** シートにアクセス
2. 以下データが正しく記録されていることを確認:
   - 組み合わせデータ（match_id, tournament_id, player1_id, player2_id）
   - 対戦結果データ（winner_id, loser_id, reported_by, approved_by）
   - レーティング情報（before/after/change）

#### 4.2 プレイヤーデータ更新確認
1. **Players** シートでレーティング更新を確認
2. **Rankings** でレート変動を確認
3. 承認済み対戦のプレイヤーレートが正しく更新されていることを確認

### Phase 5: エラーハンドリング確認
#### 5.1 エッジケースのテスト
1. **奇数人数エントリー**: 3名または5名でエントリーし、待機者表示を確認
2. **参加者不足**: 1名のみエントリーで組み合わせ生成エラーを確認
3. **重複報告**: 同じ対戦の結果を複数回報告しようとした場合の挙動

#### 5.2 権限制御確認
1. 一般プレイヤーアカウントで管理者機能にアクセスできないことを確認
2. 管理者モードボタンが一般プレイヤーには表示されないことを確認

## 確認チェックリスト

### ✅ 基本機能
- [ ] QRコード生成・表示
- [ ] QRスキャンによるエントリー
- [ ] エントリー完了後の待機画面遷移
- [ ] 組み合わせ生成（ランダム・レーティング考慮）
- [ ] 組み合わせ確定とシート保存
- [ ] 対戦結果報告（プレイヤー側）
- [ ] 結果承認・却下（管理者側）
- [ ] ELOレーティング計算・更新

### ✅ データ整合性
- [ ] TournamentMatchesシートへの正しいデータ保存
- [ ] Playersシートのレート更新
- [ ] 承認済み結果の適切な状態管理

### ✅ UI/UX
- [ ] 各画面の正しい表示
- [ ] ボタン・リンクの動作
- [ ] エラーメッセージの表示
- [ ] 成功メッセージの表示
- [ ] ローディング状態の表示

### ✅ エラーハンドリング
- [ ] 不正データでのエラー処理
- [ ] ネットワークエラー時の挙動
- [ ] 権限エラーの適切な処理

## 注意事項
1. **本番データへの影響**: テスト時は既存プレイヤーのレーティングが変更される可能性があります
2. **テスト後のクリーンアップ**: テスト用の対戦データは必要に応じて手動削除
3. **Vercel Function制限**: Hobby プランの制限により、短時間での大量リクエストは避ける
4. **Google Sheets API制限**: 過度なAPI呼び出しでレート制限にかかる可能性あり

## トラブルシューティング

### よくある問題
1. **シート作成エラー**: Google Sheets APIの権限を確認
2. **QRスキャンエラー**: カメラ権限またはHTTPS接続を確認
3. **レート計算エラー**: ELO計算ロジックとプレイヤーデータの整合性を確認
4. **承認処理エラー**: TournamentMatchesシートの構造を確認

### デバッグ情報
- ブラウザの開発者ツールでコンソールエラーを確認
- ネットワークタブでAPI呼び出しの成功/失敗を確認
- Google Sheetsで直接データの状態を確認

## 完了報告
テスト完了後は以下を報告:
1. ✅ 成功したテスト項目
2. ❌ 失敗したテスト項目（エラー詳細含む）
3. 🔧 修正が必要な項目
4. 📝 改善提案

---
**テスト実施日**: ____年____月____日  
**テスト実施者**: ________________  
**全体評価**: 🟢正常 / 🟡要修正 / 🔴重大問題