# レーティング変動表示機能の追加

## 概要
プレイヤーが試合結果を確認する際に、レーティングの変動がリアルタイムで視覚的にわかりやすく表示されるよう、対戦履歴以外の画面にもレーティング変動表示機能を追加しました。

## 実装日時
2025年8月2日

## 変更内容

### 1. プレイヤー向け対戦組み合わせ画面（TournamentMatchesView）
**ファイル**: `/src/components/TournamentMatchesView.tsx`

**追加機能**:
- 完了済み試合（status: 'approved'）でのレーティング変動表示
- 勝者には緑色の「+XX」表示
- 敗者には赤色の「-XX」表示  
- プレイヤー名とセットで変動値を表示

**表示例**:
```
勝者: ワラビサコ
+15 (ワラビサコ)  -8 (対戦相手)
```

### 2. 管理者向け試合管理画面（TournamentMatchesEditor）
**ファイル**: `/src/components/TournamentMatchesEditor.tsx`

**追加機能**:
- 管理者が試合管理を行う際にレーティング変動を確認可能
- 勝者・敗者の両方のポイント変動が一目で分かる表示
- プレイヤー向けと同様の色分け（勝者:緑、敗者:赤）

### 3. バックエンドAPI強化
**ファイル**: `/api/lib/sheets.js`

**新規追加メソッド**:
- `getMatchRatingChanges(matchId)`: 特定の試合のレーティング変動データを取得
- RatingHistoryシートから該当試合のレーティング変動情報を抽出

**既存メソッド強化**:
- `getTournamentMatches()`: 完了済み試合にレーティング変動データを自動付与
- match オブジェクトに `winner_rating_change` と `loser_rating_change` プロパティを追加

## 技術詳細

### データフロー
1. フロントエンドが `/api/matches?tournamentId=XXX` をコール
2. `getTournamentMatches()` が基本的な試合データを取得
3. 完了済み試合について `getMatchRatingChanges()` を呼び出し
4. RatingHistoryシートから該当試合のレーティング変動を取得
5. 試合データにレーティング変動情報を追加して返却

### レーティング変動データ取得ロジック
```javascript
// RatingHistoryシートから該当試合のレーティング変動を検索
const matchRatingChanges = rows
  .filter(row => row[7] === matchId) // match_id でフィルター
  .map(row => ({
    player_id: row[0],
    rating_change: parseInt(row[3]) || 0,
    result: row[6] // win/lose
  }));
```

### エラーハンドリング
- レーティング変動データが取得できない場合は警告ログを出力し、処理を継続
- APIの負荷を考慮してレート制限エラーに対応
- フロントエンドではレーティング変動データがない場合は表示しない

## UI/UX改善点

### 色分けによる視認性向上
- **勝者**: 緑色（`text-green-600`）で「+XX」形式
- **敗者**: 赤色（`text-red-600`）で「-XX」形式
- プレイヤー名と変動値をセットで表示し、誰がどのくらい変動したかを明確化

### レスポンシブ対応
- 小さな画面でも見やすいよう、テキストサイズを調整（`text-xs`）
- flexレイアウトでコンパクトに配置

## パフォーマンス考慮事項

### API呼び出し最適化
- レーティング変動は完了済み試合のみ取得（不要なAPI呼び出しを削減）
- エラー時は処理を継続し、UXを損なわない設計

### キャッシュ戦略
- 既存のマッチデータ取得と同じタイミングでレーティング変動も取得
- 30秒間隔の自動更新に含めて最新データを表示

## テスト項目

### フロントエンド
- [ ] プレイヤー向け画面で完了済み試合のレーティング変動が正しく表示される
- [ ] 管理者向け画面で勝者・敗者のレーティング変動が正しく表示される
- [ ] レーティング変動データがない場合でもエラーが発生しない
- [ ] 色分け表示が正常に機能する

### バックエンド
- [ ] `getMatchRatingChanges()` メソッドが正しいデータを返す
- [ ] RatingHistoryシートから正確にデータを取得できる
- [ ] エラー時に適切な警告ログが出力される
- [ ] API負荷が許容範囲内である

## 今後の改善予定

1. **リアルタイム更新**: WebSocket等を用いたリアルタイム更新機能
2. **アニメーション**: レーティング変動時のアニメーション効果
3. **詳細表示**: レーティング計算の詳細（Kファクター、期待勝率等）の表示

## 関連ドキュメント
- [ELOレーティングシステム実装](./elo_rating_system.md)
- [試合管理システム](./match_management_system.md)
- [API仕様書](./api_specifications.md)