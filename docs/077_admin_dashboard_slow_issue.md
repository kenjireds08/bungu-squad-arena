# 077 - 管理画面リロード遅延問題の調査

## 日付
2025-08-15

## 問題の詳細
- 管理画面のリロードに約30秒かかる
- 大会作成後の表示更新が遅い

## 原因分析

### 1. API呼び出しの問題
- `useRankings`で`rankings` APIが504タイムアウト
- 代わりに`players` APIを使用してソート（緊急対応）
- Google Sheets APIのレート制限に到達している可能性

### 2. ポーリング設定
- `useVersionPolling`が1.5秒ごとに実行
- 管理画面で複数のクエリが頻繁に実行される
  - players
  - tournaments
  - rankings（実際はplayers）

### 3. キャッシュ戦略
- `staleTime: 1000 * 30`（30秒）は短すぎる
- 管理画面を開くたびに全データを再取得

## 改善案

### 短期対策（即効性あり）
1. キャッシュ時間を延長
   - staleTime: 5分に延長
   - 管理画面での頻繁な再取得を防ぐ

2. ポーリング頻度を下げる
   - 1.5秒 → 5秒に変更
   - 必要な時のみポーリング有効化

3. リトライ設定の最適化
   - retry: false または 1回に制限
   - タイムアウト時の無駄な再試行を防ぐ

### 長期対策（根本解決）
1. サーバーサイドキャッシュの実装
   - Vercel KVでデータをキャッシュ
   - Google Sheets APIの呼び出し回数を削減

2. ページネーションの実装
   - プレイヤー一覧を分割取得
   - 初期表示の高速化

3. バックグラウンド更新
   - データ更新を非同期で実行
   - ユーザーには古いデータを先に表示

## 次のステップ
1. まず短期対策を実装してテスト
2. 効果を測定
3. 必要に応じて長期対策を検討